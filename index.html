<!DOCTYPE html>
<html lang="es" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Turismo Piombino - Traslados y Viajes</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <style>
        :root { --primary-color: #00796b; --whatsapp-color: #25D366; --whatsapp-hover-color: #1DAE56; }
        html { scroll-behavior: smooth; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        .container { max-width: 1100px; }
        nav { position: sticky; top: 0; z-index: 1000; background-color: var(--pico-card-background-color); border-bottom: 1px solid var(--pico-card-border-color); padding: 0.5rem 1rem; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        nav ul { margin-bottom: 0; }
        .evento-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 1.5rem; margin-top: 2rem; }
        .evento-card { border: 1px solid var(--pico-muted-border-color); border-radius: var(--pico-border-radius); padding: 0; display: flex; flex-direction: column; overflow: hidden; transition: transform 0.2s, box-shadow 0.2s; }
        .evento-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.05); }
        .evento-card-contenido { padding: 1.5rem; flex-grow: 1; display: flex; flex-direction: column; }
        .evento-card-contenido h5 { margin-bottom: 0.5rem; }
        .evento-card-contenido p { color: var(--pico-secondary); margin-bottom: 1rem; flex-grow: 1; }
        .evento-card-contenido button { background-color: var(--primary-color); border-color: var(--primary-color); width: 100%; }
        .evento-card.agotado { opacity: 0.6; }
        .evento-card.agotado button { background-color: var(--pico-muted-border-color); border-color: var(--pico-muted-border-color); pointer-events: none; }
        .punto-recogida { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; }
        .punto-recogida input { flex-grow: 1; }
        .punto-recogida button { width: auto; padding: 0 0.75rem; line-height: 1.5rem; background-color: var(--pico-muted-background-color); color: var(--pico-muted-color); border: 1px solid var(--pico-muted-border-color); }
        footer { margin-top: 4rem; padding: 2rem 1rem; border-top: 1px solid var(--pico-muted-border-color); text-align: center; background-color: var(--pico-muted-background-color); }
        footer a { font-size: 1.5rem; margin: 0 0.5rem; color: var(--pico-secondary); }
        section { padding-top: 5rem; }
    </style>
</head>
<body>
    <nav class="container-fluid">
        <ul><li><strong><a href="#">Turismo Piombino</a></strong></li></ul>
        <ul><li><a href="#proximos-eventos">Próximos Eventos</a></li><li><a href="#otros-servicios">Otros Servicios</a></li><li><a href="#disponibilidad">Disponibilidad</a></li></ul>
    </nav>
    <main class="container">
        <section id="proximos-eventos">
            <h2 style="text-align:center;">Traslados a Próximos Eventos</h2>
            <div id="eventos-lista" class="evento-grid">
                <p aria-busy="true">Cargando eventos disponibles...</p>
            </div>
        </section>
        <hr>
        <section id="otros-servicios">
             <h3 style="text-align:center;">¿Necesitas otro tipo de traslado?</h3>
             <p style="text-align:center;">Para eventos sociales, corporativos, aeropuertos o viajes privados, haz clic aquí.</p>
             <div style="text-align: center;">
                <button onclick="abrirModalCotizacion({ nombre: 'Servicio Personalizado' })">Cotizar Otro Servicio</button>
             </div>
        </section>
        <hr>
        <section id="disponibilidad">
            <h2>Disponibilidad General</h2>
            <p>Este calendario muestra los bloques de tiempo ocupados. Si tu fecha está libre, ¡no dudes en consultar!</p>
            <div class="calendar-container" style="position: relative; padding-bottom: 75%; height: 0; overflow: hidden; max-width: 100%;">
                <iframe src="https://calendar.google.com/calendar/embed?src=e7dc2c14d6465b8137e09d3128566ae23a25b3110fc57aee79302fa1990c1552%40group.calendar.google.com&ctz=America%2FArgentina%2FBuenos_Aires" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0;"></iframe>
            </div>
        </section>
    </main>
    <footer id="contacto">
      <p><strong>Turismo Piombino © 2025</strong></p>
      <p>Seguinos en nuestras redes:</p>
      <a href="https://www.instagram.com/turismo_piombino/" target="_blank" aria-label="Instagram"><i class="fa-brands fa-instagram"></i></a>
      <a href="https://www.facebook.com/leo.piombino" target="_blank" aria-label="Facebook"><i class="fa-brands fa-facebook"></i></a>
    </footer>

    <dialog id="modal-cotizacion">
      <article>
        <header>
          <button aria-label="Close" rel="prev" onclick="document.getElementById('modal-cotizacion').close()"></button>
          <h4 id="modal-titulo">Solicitud de Cotización</h4>
        </header>
        <form id="cotizacion-form-container">
            <input type="hidden" id="form-evento-nombre" name="evento_nombre">
            <input type="hidden" id="form-evento-fecha" name="evento_fecha">
            <input type="hidden" id="form-evento-lugar" name="evento_lugar">
            
            <label>Nombre y Apellido <input type="text" name="nombre_cliente" required></label>
            <label>Teléfono (con cód. de área) <input type="tel" name="telefono" required></label>
            <label>Cantidad Total de Pasajeros <input type="number" name="pasajeros_totales" min="1" required></label>

            <fieldset>
                <legend>Puntos de Recogida</legend>
                <div id="puntos-recogida-container">
                    <div class="punto-recogida"><input type="text" name="puntos_de_recogida[]" placeholder="Dirección del primer punto" required></div>
                </div>
                <button type="button" class="secondary" onclick="anadirPuntoRecogida()">+ Añadir otro punto</button>
            </fieldset>

            <label>Detalles Adicionales (Ej: Solo Ida / Solo Vuelta) <textarea name="detalles"></textarea></label>
            <button type="submit">Contactar por WhatsApp</button>
        </form>
      </article>
    </dialog>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const telefonoPiombino = "5491123757821";
    const googleSheetEventosUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTGqjcBT-GiILtXal_RQqsBrr7HypTsWgyJT8KgmIBa7YnhjyId1TLsDnj3f-1dMA5BF3Op5PF-wQdN/pub?output=csv';
    const scriptCarteroUrl = 'https://script.google.com/macros/s/AKfycbwKpO5eAfa1xR8ITcQo8dCfGWCCq23a1BuC3simU84Orf_o7iGLH4VaxUOO0kZuKwUKxA/exec';
    
    let eventos = [];
    const listaEventosContainer = document.getElementById('eventos-lista');
    const modal = document.getElementById('modal-cotizacion');
    const form = document.getElementById('cotizacion-form-container');

    function csvToArray(csv) {
        const lines = csv.split(/\r?\n/);
        const headers = lines[0].split(',');
        const data = [];
        const regex = /,(?=(?:(?:[^"]*"){2})*[^"]*$)/;
        for (let i = 1; i < lines.length; i++) {
            if (!lines[i]) continue;
            const values = lines[i].split(regex);
            if (values.length === headers.length) {
                const obj = {};
                for (let j = 0; j < headers.length; j++) {
                    let value = values[j] || '';
                    if (value.startsWith('"') && value.endsWith('"')) { value = value.slice(1, -1); }
                    obj[headers[j].trim()] = value.trim();
                }
                data.push(obj);
            }
        }
        return data;
    }
    
    async function fetchAndRenderEvents() {
        if (!listaEventosContainer) return;
        try {
            const response = await fetch(googleSheetEventosUrl, { cache: 'no-store' });
            if (!response.ok) { throw new Error(`Error de red: ${response.statusText}`); }
            const csvText = await response.text();
            eventos = csvToArray(csvText);
            listaEventosContainer.innerHTML = ''; 
            if (eventos.length === 0) { listaEventosContainer.innerHTML = '<p>No hay eventos programados por el momento.</p>'; return; }
            
            eventos.forEach(evento => {
                if (!evento.id || !evento.nombre) return;
                const esAgotado = evento.estado === 'agotado';
                const tarjeta = document.createElement('article');
                tarjeta.className = `evento-card ${esAgotado ? 'agotado' : ''}`;
                tarjeta.innerHTML = `
                    <div class="evento-card-contenido">
                        <h5>${evento.nombre}</h5>
                        <p><i class="fa-regular fa-calendar"></i> ${evento.fecha}<br><i class="fa-solid fa-location-dot"></i> ${evento.lugar}</p>
                        <button onclick='abrirModalCotizacion(${JSON.stringify(evento)})' ${esAgotado ? 'disabled' : ''}>
                            ${esAgotado ? 'Cupos Agotados' : 'Cotizar Traslado'}
                        </button>
                    </div>`;
                listaEventosContainer.appendChild(tarjeta);
            });
        } catch (error) {
            console.error('Error al cargar los eventos:', error);
            listaEventosContainer.innerHTML = '<p>Hubo un error al cargar los eventos.</p>';
        }
    }

    window.abrirModalCotizacion = function(evento) {
        form.reset();
        document.getElementById('puntos-recogida-container').innerHTML = '<div class="punto-recogida"><input type="text" name="puntos_de_recogida[]" placeholder="Dirección del primer punto" required></div>';
        
        // Llena el título y los campos ocultos con la info del evento
        document.getElementById('modal-titulo').innerText = `Cotización para: ${evento.nombre}`;
        form.querySelector('#form-evento-nombre').value = evento.nombre || 'Servicio Personalizado';
        form.querySelector('#form-evento-fecha').value = evento.fecha || '';
        form.querySelector('#form-evento-lugar').value = evento.lugar || '';
        
        modal.showModal();
    }

    window.anadirPuntoRecogida = function() {
        const container = document.getElementById('puntos-recogida-container');
        const nuevoPunto = document.createElement('div');
        nuevoPunto.className = 'punto-recogida';
        nuevoPunto.innerHTML = `<input type="text" name="puntos_de_recogida[]" placeholder="Siguiente dirección"><button type="button" onclick="this.parentElement.remove()">-</button>`;
        container.appendChild(nuevoPunto);
    }
    
    form.addEventListener('submit', (e) => {
        e.preventDefault();
        const formData = new FormData(form);
        const puntos = Array.from(form.querySelectorAll('input[name="puntos_de_recogida[]"]'))
                            .map(input => input.value.trim()).filter(value => value !== '').join(' | ');
        
        // Preparamos los datos para la planilla y el mensaje de WhatsApp
        const tipoServicio = formData.get('evento_nombre');
        const nombreCliente = formData.get('nombre_cliente');
        const telefono = formData.get('telefono');
        const pasajeros = formData.get('pasajeros_totales');
        const detalles = formData.get('detalles');
        
        const dataParaSheet = new FormData();
        dataParaSheet.append('tipo_servicio', tipoServicio);
        dataParaSheet.append('nombre_cliente', nombreCliente);
        dataParaSheet.append('telefono', telefono);
        dataParaSheet.append('pasajeros_totales', pasajeros);
        dataParaSheet.append('puntos_de_recogida', puntos);
        dataParaSheet.append('detalles', `Fecha Evento: ${formData.get('evento_fecha')}, Lugar: ${formData.get('evento_lugar')}. Detalles Adicionales: ${detalles}`);
        
        fetch(scriptCarteroUrl, { method: 'POST', body: dataParaSheet })
            .catch(error => console.error("Error al enviar a la planilla:", error));

        const msg = `¡Hola! Quisiera cotizar un servicio de *${tipoServicio}*.\n` +
                  `- Cliente: ${nombreCliente}\n` +
                  `- Teléfono: ${telefono}\n` +
                  `- Pasajeros: ${pasajeros}\n` +
                  `- Puntos de Recogida: ${puntos.replace(/ \| /g, ', ')}\n` +
                  `- Detalles Adicionales: ${detalles}`;
        
        window.open(`https://wa.me/${telefonoPiombino}?text=${encodeURIComponent(msg)}`, '_blank');
        modal.close();
    });

    fetchAndRenderEvents(); // Llama a la función para construir las tarjetas de eventos al cargar la página
});
</script>
</body>
</html>
